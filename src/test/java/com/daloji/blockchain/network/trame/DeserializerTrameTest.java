package com.daloji.blockchain.network.trame;


import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.util.ArrayDeque;
import java.util.Properties;

import org.junit.Assert;
import org.junit.BeforeClass;
import org.junit.Test;

import com.daloji.blockchain.core.Utils;
import com.daloji.blockchain.network.IPVersion;
import com.daloji.blockchain.network.peers.PeerNode;
import com.daloji.blockchain.network.trame.DeserializerTrame;
import com.daloji.blockchain.network.trame.TrameHeader;
import com.daloji.blockchain.network.trame.VersionAckTrame;
import com.daloji.blockchain.network.trame.VersionTrameMessage;


public class DeserializerTrameTest {
	
	private static String trame="F9BEB4D976657273696F6E000000000066000000E853E24E7F1101000D0400000000000034D51C5E00000000000000000000000000000000000000000000FFFF55AA707389C60D04000000000000000000000000000000000000000000000000012A799748954F40102F5361746F7368693A302E31382E302F6159090001F9BEB4D976657261636B000000000000000000005DF6E0E2";

	private static String partial_trame="F9BEB4D976657273696F6E000000000068000000C79722900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

	 private static String trame_block;
	
	@BeforeClass
	public static void before() throws IOException {
		ClassLoader classLoader = InvTrameTest.class.getClassLoader();
		File file = new File(classLoader.getResource("test.properties").getFile());
		Properties prop = new Properties();
        // load a properties file
        prop.load(new FileInputStream(file));
        trame_block = (prop.getProperty("trame_block"));
          
	}
	@Test
	public  void  deserialiseTest_OK() {
		
		PeerNode peer = new PeerNode(IPVersion.IPV4);
		peer.setHost("127.0.0.1");
		peer.setPort(8333);
		ArrayDeque<TrameHeader> stackCommand = DeserializerTrame.getInstance().deserialise(null,Utils.hexStringToByteArray(trame), peer);
		Assert.assertNotNull(stackCommand); 
		Assert.assertEquals(stackCommand.size(), 2);
		TrameHeader trameheader = stackCommand.pop();
		Assert.assertTrue(trameheader instanceof VersionTrameMessage);
		trameheader = stackCommand.getFirst();
		Assert.assertTrue(trameheader instanceof VersionAckTrame);
		
	}
	
	@Test
	public void deserialiseTestPartialTram() {
		PeerNode peer = new PeerNode(IPVersion.IPV4);
		peer.setHost("127.0.0.1");
		peer.setPort(8333);
		ArrayDeque<TrameHeader> stackCommand = DeserializerTrame.getInstance().deserialise(null,Utils.hexStringToByteArray(partial_trame), peer);
		Assert.assertNotNull(stackCommand); 
		Assert.assertEquals(stackCommand.size(), 1);
		TrameHeader trameheader = stackCommand.pop();
		Assert.assertTrue(trameheader instanceof VersionTrameMessage);

	}
	
	
	@Test
	public void deserialise_001() {
		String trame = "F9BEB4D970696E6700000000000000000800000095C4B6569731BEF7F83EBDEFF9BEB4D96164647200000000000000001F00000012A6028B011E29135E000000000000000000000000000000000000FFFF34C60702208DF9BEB4D967657468656164657273000005040000259959F67F1101001FB4CBE4C778CBD72FBD8A82A9B7814962F299400CD90C0F000000000000000000B1A9BEFE16213662E275C06EF2FD7B38F62E1169D1D60E00000000000000000086A70568B0FD5CD5D00D4768137AE80469A02ED8676D000000000000000000000F20E6800CA85ABCFAF804F229CD7F780916F00CA097090000000000000000001B405390134E922CA5BAA7987464DF0B65864AE19CC20600000000000000000031257FE7D2E0C884EAE78C2C51C85633C3AC2482E0BF130000000000000000002DE5C6C0BA33F2EFEF320C7891CA58E68531DC2E3A1E06000000000000000000229887C71E2EF65D776E57A3004AF35327E105E6C00303000000000000000000A638D624975F292E713C8D22BA3C3404670F7C680EBD01000000000000000000ECA92049069C2610C06FEC2ACD71CCF1F16A6CB2397F0E00000000000000000017295DEE509BC39275056A887A065C4763E5F10E3DC20C0000000000000000008B750AA429984D588172CE5037370ACDCE1AEE61CE5D0D0000000000000000008B0E81787DFD1C3A0A7699BCEA7D7AD63136B30619B80B000000000000000000E3D1A2B6028A2B58618E19D41DE4C140A361CFC7725F10000000000000000000F7DD653750E6B63F79174EA77BFA25FC2DEC86379D260400000000000000000056351E085D495D65F84C50531F1434EF53EC105593A0010000000000000000006C7BE70E862DC59EE39F5FA9F09C22D482D1E43ED89D08000000000000000000CA358209C26AC737AE9077E83E508D0080DBC6BCCE300100000000000000000084C39A32DCE2CC257E885749773DC2B45C60DE85349B0300000000000000000024371F6917F9657B5546CF1CE0C88D5201B1EF7C57B5010000000000000000005C10128231F8EBB76A2767E560B22A15466D5DB810650F00000000000000000063A6C249375D164A16F60BFB4DED78CC04AC086712D2120000000000000000002A64E403C2C92F5A701B9415DE9459411941165958B40C000000000000000000C8E8EA6C3BF6BFE9D30C6D91A8AD8CC31D8D8C6CB6210D0000000000000000006E9EE62DF9E40F08C33505971FFF11A1074EAE2700820D000000000000000000140F5B9C4D6B98EA943A6B867F6474DDEC8FB44042D3190000000000000000002DD6D6DD566FFC718A2BB27279969127F3616CE3AFB21E000000000000000000AEFCC45523EE6A84B4A3F3C15F417B1CBFDD4F6B5EA8140100000000000000001E65DEE634DFCF597775EB81";
		PeerNode peer = new PeerNode(IPVersion.IPV4);
		peer.setHost("127.0.0.1");
		peer.setPort(8333);
		ArrayDeque<TrameHeader> stackCommand = DeserializerTrame.getInstance().deserialise(null,Utils.hexStringToByteArray(trame), peer);
		Assert.assertNotNull(stackCommand); 
		Assert.assertEquals(stackCommand.size(), 3);
		TrameHeader trameheader = stackCommand.pop();

	}
	
	
	/**
	 * 
	 */
	
	@Test
	public void deserialise_002() {
		String trame ="F9BEB4D973656E646865616465727300000000005DF6E0E20000000000000000000000000000FFFF55AA7073C9AE0904000000000000000000000000000000000000000000000000C56A088FD1A7AAC7122F5361746F7368693A302E31392E302E312F095C090001F9BEB4D976657261636B000000000000000000005DF6E0E2";
		PeerNode peer = new PeerNode(IPVersion.IPV4);
		peer.setHost("127.0.0.1");
		peer.setPort(8333);
		ArrayDeque<TrameHeader> stackCommand = DeserializerTrame.getInstance().deserialise(null,Utils.hexStringToByteArray(trame), peer);
		Assert.assertNotNull(stackCommand); 
		Assert.assertEquals(stackCommand.size(), 2);
	}
	
	
	/**
	 * 
	 */
	
	//@Test
	public void deserialise_003() {
		String trame = "F9BEB4D9696E760000000000000000001D0200006E11642EF9BEB4D973656E64636D70637400000009000000E92F5EF8000200000000000000F9BEB4D973656E64636D70637400000009000000CCFE104A000100000000000000F9BEB4D970696E67000000000000000008000000FE6B9C7A9BE897B7016B9EE0F9BEB4D96164647200000000000000001F000000129DF5DA019101235E0D0400000000000000000000000000000000FFFF17622BAA208DF9BEB4D9676574686561646572730000050400008CC92A627F1101001FB5110CFB25A54544D8A8712039321D2BE9AEB04A97870B00000000000000000043475F166CD2DE20080A4D729BD1D8AB2A60C7A29C0206000000000000000000171459FB4028495CDA12DC1C6D0A7C88E7655D662CAD0B0000000000000000005CA7F6BB259F5E2E908A20D56BEFB3ECE2B00B03315D06000000000000000000ACA25392922F682EEEED000FE2A9BC2BD82773513C3C090000000000000000007FD109ECD6662C41B90E42422D5C75082CA396FFB7EC0E00000000000000000070908626E4E7DBF8599F5C5DBA510C31C563EFE4EEBC04000000000000000000F26C0599C117B9C65F8EA3F00166B84A6F09D302047E02000000000000000000A5991EACD8B83CC9AC335F253580B76FBA2B9FBF848B0D0000000000000000003EF4BC430BB69E1C9098B83C842ED08E2FA475795D0908000000000000000000367FF169B0BBF07460F3404B58DE872D5645F826415B050000000000000000004082312F3B8469AA2FAD8138586AD7096CC1084A66740B000000000000000000288E76EC0A5AFAD4FC53E5C5F5E3FA4429B287891BA9120000000000000000006726F96ABC695E64E45C89FD3BD4C67AB6F25DC8E8BA0F000000000000000000B0F2BAA41912BFC9F7EC84A22D70E18A6520B6473DE00B00000000000000000094FB83F9FB36E5F387FDFAC60237E9ECBE92B135198D00000000000000000000FD3B8BFCF120290D5C3A9974CF5C0F7AECE98FA5157A0000000000000000000093A28059DEBF929C74F16B2EBEE47625F637B674F6250B000000000000000000744923599978C42BDF4253934617802D0DF9630A9814080000000000000000003D9D6839CC06344E0D276C6A12354F78A9FBBFCD55E30A00000000000000000007DC477F84FA96B3AECDD7B9C394EEE2E3E43CE9B01F01000000000000000000445698350B2C4B9184C75E0CDC23E9865100ADAB1BA305000000000000000000E1E0924BB7A8F63C56E51F62B72C342666E8B62E88A90100000000000000000069F501F5910A98EF2F7F180E080285CFABDEA4C521DE0C0000000000000000005B027CB213D3B2CF2DADCDD55E8613908A80CFC580EA0C000000000000000000FFCEBC1CD7D4407FACE4E4F347F691A5B7C7569AC71407000000000000000000D8E81CEC76D94EE384234DCBB18C560E1921B9ADC01506000000000000000000767AB008C4E4D92403F706C4BE25C04E2651BA10F2F0ED00000000000000000019635D4A135C50D38E1546EF3E669B82351C8A6FE731E5090000000000000000ED11BF51E77B3D741AD1CC362FA84FB71A4F1C7F204A0C1DE0770600000000006FE28C0AB6F1B372C1A6A246AE63F74F931E8365E15A089C68D61900000000000000000000000000000000000000000000000000000000000000000000000000F9BEB4D966656566696C74657200000008000000E80FD19FE803000";
		PeerNode peer = new PeerNode(IPVersion.IPV4);
		peer.setHost("127.0.0.1");
		peer.setPort(8333);
		ArrayDeque<TrameHeader> stackCommand = DeserializerTrame.getInstance().deserialise(null,Utils.hexStringToByteArray(trame), peer);
		Assert.assertNotNull(stackCommand); 
		Assert.assertEquals(stackCommand.size(), 6);
	}
	
	
	/**
	 * 
	 */
	
	@Test
	public void deserialise_004() {
		String trame = "F9BEB4D9696E76000000000000000000ED04000003EEA8B02301000000807F69F9BA753AAA3F373D89AC8EC7D7A262BF807A89E2BD35F52CDD8011250701000000ED3B0BFADEBA9AA11CADF0999D0A664E55BAEA1378427EDEF11C7B193CE0163A01000000B1B90275D7ABE4F87EE49ABA5431F6B4EF4549AC2C0354CF843667F9D6FCFC2001000000891A894A8152015EC5B8B17041714DB70386747C13770F2293C4CB289F95F3600100000036F55AA33DAEAA2576806FF0BC77963229F552109CF69DBC1EFB1ABE7DC889EB01000000ABA2A10D8BC61BFA0ACC7C1031EE871219640A8EDE3C7FAB86173CEEC585C1F101000000CF0FE5BBA798DD7E65E2D2D6799136E197F23DD48CB874816D8E8B9480C4365801000000F5D72AD72055C330ACA6A58E930416FF0CAA8C252DA5F746D5FB180D22594E7A01000000A68DA976EF4F2ACF517EC5BFBE9618F8A5F8FAF2FC63A6AD97ABA76B4DF97D59010000007E81EFDE1842BA8BED3C033728D4BCAAE82CFBEB5818F73C52C039297A83626D010000007AB348B98E9CD4E1F5BADCA1EFD7EDB5FD2BD6C33239DA9960DE344565B94649010000000311207787B06A234273BE318059721E5F0BFB0FE27E871FBACE003528F0D0850100000098FF5F72890A5E28364A1691CC2B7FCA8F470E2060862F6476E0E97A9C312A8D0100000053FD11AB3DDA5E398DAB351AE1BB50D35064932FAEE659B00465A24827B0C784010000003FF48816068F4D71C7D6B8442830CEAB9554561AC9C66A23B1C7096105B27D56010000001E9BB69E09B37EACBCB9E9595791578E5FEF183E4BA4394F914F68366FF3FC1501000000ED21B58E4248A62D3E3ACA55372A93C64804B56066D1EE8924200B95FF948F4801000000B1467BC21F7FAE25666A288FD4B6A721FC9105D213AD78B421260EB9FA9B71D90100000021D3306B43A7CA296A32944ACC95EE56EA9D84A9F55966922969CDA1942F4C6D0100000028CF4AEE2124172400C43244A5634374E2EAE52C5A3429E5DFBEA19ECD71F2AD01000000E2AEDE513C96A17484BE3E705736DFA59A449AD06A86CABD402C46667EF17C7C01000000F4ABAEF30471BDE4F34126F18D2979173FFF88ACC25C0586611F9ECCA9063F0601000000ECD4B556C81F28BD8CAFB332E3FAA7409DC2DC09DBD5C1DC76A9BB3F0F7EF10001000000CDDA5CBAECDA9C771F21708B4B81F4E7821B143826669FE26D65DE7C1C5A590D01000000C7E508A733C312A0D5CE3F892A9A2314C67A970F8CD0F3DE25A6C78FC68A094D01000000B818356E7202AB5062E634AB1D254A898175E8D0230F2D0DC0DC76A2E915D05501000000B54B281A7268BA4C062A18C6A02C59DB2AFE4601437A803833A9E7C363381BC701000000AC78D1E466B0576CA8FEB6AAF54D53D1062FCF4AB13220E1F920C9422B80E1E4010000000EFB06ACDD9560F81469228A9D4D44F5B82C22A2086A53E699C13F2F25170C6B010000004204BB400D778165C25BF85D8A61546DA8936E17DAC341E69ED6E06A874FEE160100000067586AFB88CB2824F4A80647547577FA2FEC930C3D7A7D2C9A026450007236BA01000000D42723E25D829187531C823425A09E59703C7355334EA915A0CEEF466AD3E68E010000005534ECCF18B9C611E0D6FA45D3C0CF05310911715CD6935AFF0421B1BE227D5201000000E830723FFB1F707F510941A6E087E0BD0380AC8C96550DB6B516BF75A7ABBE3001000000095690709F9F2A0223C45622E2A4B5997BD961420DE631BD890C4856E1632B780000";
		PeerNode peer = new PeerNode(IPVersion.IPV4);
		peer.setHost("127.0.0.1");
		peer.setPort(8333);
		ArrayDeque<TrameHeader> stackCommand = DeserializerTrame.getInstance().deserialise(null,Utils.hexStringToByteArray(trame), peer);
		Assert.assertNotNull(stackCommand); 
		Assert.assertEquals(stackCommand.size(), 1);
		InvTrame inv =(InvTrame) stackCommand.getLast();
		Assert.assertEquals(inv.getListinv().size(), 35);

	}
	
	
	/**
	 * 
	 */
	
	@Test
	public void deserialise_005() {
		String trame = "F9BEB4D966656566696C74657200000008000000E80FD19FE80300000000000013CE3E35826B6F298B344D8EBEFCCA276080C20D000000000000000000B5525140A7F0427ACA6EC98F481C213A803D5F24AE6604000000000000000000DF5E4F806E01C562736EE974AAD0F305210E5F5DF3990800000000000000000035E7A12F440FF014E40D73BCD8C86B340A14ED766B0D100000000000000000001740400208D0A345D4A0A353B44D24D0772384FF511A0D000000000000000000651D3D922FF753F9B58F0A8492D5825F32FAA286A94C09000000000000000000943F721169318B3BBA5C82AE8775A8E2B2C6262946AA09000000000000000000E3956B34F4EDFED77810C55AE0DA59DBE0E04F7FC1150F0000000000000000006F26D9F4FB8F6DDBD7CDA3A29563119291F8217523F70E000000000000000000FF2E295D71A5518E74A1D542292EB37C003D2BEAC4ED04000000000000000000AB16D7372E31F5C3F805FAA42F9BA09DF7BEB71CDBC20B000000000000000000A8EF4D25CC26C734A68A958C6A35182AF3CC1639E253030000000000000000001380144EE978AE7849903F193038A00213690006ABC305000000000000000000171459FB4028495CDA12DC1C6D0A7C88E7655D662CAD0B000000000000000000367FF169B0BBF07460F3404B58DE872D5645F826415B0500000000000000000004BC634BBC00100CAE08417866174DB7EECEA095858B0C00000000000000000008F24527B7DC7E411F2FD0656AF0843148B04C70FE8600000000000000000000CB72D66E9A0FCDD8B9EC967F329EECC7786E45D4983B11000000000000000000318BDE32685DCD5347BABB336ADE3FF3ADD66DA978DE0D000000000000000000DE56F157EB388EF5EA1BE6BDD382B2594F9E21CCD8DA040000000000000000006994B03FA47710E59B5A7F1FDF893781AE4FB7637BC412000000000000000000327699898D693C56105B52548ED709A98A812D98C0D0120000000000000000009559329CD2E0F8D72B0D4FD8272C8BCC234B0F0997B010000000000000000000B6FFE6B64807F0B1965403A53F6CAA2E69E2A2E1AC290D00000000000000000011937EE577A6EC965EABF1C74453DCABA0F3C3E724F6100000000000000000008BD7BC7FDA56594EFE153A07C0731C1F311A60885FCE01000000000000000000A49BFAAF1969EF378AEE16C35A2923FEB0CCC0A9D1D1080000000000000000002EC58F9EA04D7CC78D4A12A40D2A6806B9968D3C300FA500000000000000000081FB235C3F18494E72460B75EDD3B07B0B0FDD905A440B0F0000000000000000251D8EBD52720510BA498847A4F788E96854F61D07538D5CDFB50D00000000006FE28C0AB6F1B372C1A6A246AE63F74F931E8365E15A089C68D6190000000000000000";
		PeerNode peer = new PeerNode(IPVersion.IPV4);
		peer.setHost("127.0.0.1");
		peer.setPort(8333);
		ArrayDeque<TrameHeader> stackCommand = DeserializerTrame.getInstance().deserialise(null,Utils.hexStringToByteArray(trame), peer);
		Assert.assertNotNull(stackCommand); 
		Assert.assertEquals(stackCommand.size(), 2);

	}
	
	
	/**
	 * 
	 */
	
	@Test
	public void deserialise_007() {
		String trame = "F9BEB4D973656E646865616465727300000000005DF6E0E2F9BEB4D973656E64636D70637400000009000000E92F5EF80000000000000000000000000000FFFF55AA70739BB80D04000000000000000000000000000000000000000000000000F1AABE9A3240BA0C102F5361746F7368693A302E31382E302F4B5C090001F9BEB4D976657261636B000000000000000000005DF6E0E20000";
		PeerNode peer = new PeerNode(IPVersion.IPV4);
		peer.setHost("127.0.0.1");
		peer.setPort(8333);
		ArrayDeque<TrameHeader> stackCommand = DeserializerTrame.getInstance().deserialise(null,Utils.hexStringToByteArray(trame), peer);
		Assert.assertNotNull(stackCommand); 
		Assert.assertEquals(stackCommand.size(), 2);

	}
	
	/**
	 * 
	 */
	
	@Test
	public void deserialise_008() {
		String trame = "F9BEB4D973656E64636D70637400000009000000E92F5EF8000200000000000000F9BEB4D973656E64636D70637400000009000000CCFE104A000100000000000000F9BEB4D970696E67000000000000000008000000D8B3E6B2B44D3FAFFF620AB9F9BEB4D96164647200000000000000001F0000008BD6137E01E739245E0D0400000000000000000000000000000000FFFF42BF8E44208DF9BEB4D967657468656164657273000005040000F0E50BF100";
		PeerNode peer = new PeerNode(IPVersion.IPV4);
		peer.setHost("127.0.0.1");
		peer.setPort(8333);
		ArrayDeque<TrameHeader> stackCommand = DeserializerTrame.getInstance().deserialise(null,Utils.hexStringToByteArray(trame), peer);
		Assert.assertNotNull(stackCommand); 
		Assert.assertEquals(stackCommand.size(), 5);
		GetHeadersTrame getHeader =(GetHeadersTrame) stackCommand.getLast();
		Assert.assertEquals(getHeader.isPartialTrame(), true);

	}
	/**
	 * 
	 */
	
	//@Test
	public void deserialise_009() {
		String trame = "F9BEB4D973656E646865616465727300000000005DF6E0E2F9BEB4D973656E64636D70637400000009000000E92F5EF80000000000000000000000000000FFFF55AA7073E0100D04000000000000000000000000000000000000000000000000C9C03247391F06D8112F5361746F7368693A302E31372E39392FA35C090001F9BEB4D976657261636B000000000000000000005DF6E0E200";
		PeerNode peer = new PeerNode(IPVersion.IPV4);
		peer.setHost("127.0.0.1");
		peer.setPort(8333);
		ArrayDeque<TrameHeader> stackCommand = DeserializerTrame.getInstance().deserialise(null,Utils.hexStringToByteArray(trame), peer);
		Assert.assertNotNull(stackCommand); 
		Assert.assertEquals(stackCommand.size(), 5);
		GetHeadersTrame getHeader =(GetHeadersTrame) stackCommand.getLast();
		Assert.assertEquals(getHeader.isPartialTrame(), true);

	}
	
	/**
	 * 
	 */
	
	@Test
	public void deserialise_010() {
		PeerNode peer = new PeerNode(IPVersion.IPV4);
		peer.setHost("127.0.0.1");
		peer.setPort(8333);
		ArrayDeque<TrameHeader> stackCommand = DeserializerTrame.getInstance().deserialise(null,Utils.hexStringToByteArray(trame_block), peer);
		Assert.assertNotNull(stackCommand); 
		Assert.assertEquals(stackCommand.size(), 6);
		TrameHeader trame = stackCommand.removeLast();
		Assert.assertEquals(trame instanceof ErrorTrame ,true);
		BlockTrame block =(BlockTrame) stackCommand.getLast();
		Assert.assertEquals(block.getChecksum(), "934D270A");
		Assert.assertEquals(block.getMerkelRoot(), "982051FD1E4BA744BBBE680E1FEE14677BA1A3C3540BF7B1CDB606E857233E0E");
		Assert.assertEquals(block.getTime(), 1231469665);
		Assert.assertEquals(block.getPreviousHash(), "6FE28C0AB6F1B372C1A6A246AE63F74F931E8365E15A089C68D6190000000000");
		Assert.assertEquals(block.getVersion(), "01000000");
		Assert.assertEquals(block.getNonce(),(long) 2573394689L);


	}
	
	
	
}
